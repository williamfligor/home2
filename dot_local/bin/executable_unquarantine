#!/usr/bin/env python3

from pathlib import Path
import subprocess
import stat


def has_quarantine(path: Path) -> bool:
    """Check if path has quarantine attribute"""
    try:
        result = subprocess.run(
            ["xattr", "-l", str(path)],
            capture_output=True,
            text=True,
            check=True
        )
        return "com.apple.quarantine" in result.stdout
    except subprocess.CalledProcessError:
        return False


def remove_quarantine(path: Path):
    """Remove quarantine attribute if it exists"""
    if has_quarantine(path):
        cmd = ["xattr", "-r", "-d", "com.apple.quarantine", str(path)]
        try:
            subprocess.run(cmd, check=True)
            print(f"Removed quarantine attribute from: {path}")
        except subprocess.CalledProcessError:
            print(f"Failed to remove quarantine attribute from: {path}")


def is_executable(path: Path) -> None:
    return path.is_file() and bool(path.stat().st_mode & stat.S_IXUSR)


def process_directory(directory: Path):
    """Process directory to find .app bundles and executable files"""
    # Find all .app directories
    for app_path in directory.rglob("*.app"):
        if app_path.is_dir():
            remove_quarantine(app_path)

    # Find all executable files
    for file_path in directory.rglob("*"):
        if is_executable(file_path):
            remove_quarantine(file_path)


if __name__ == "__main__":
    process_directory(Path.home() / "Applications")
    process_directory(Path.home() / ".local" / "bin")
